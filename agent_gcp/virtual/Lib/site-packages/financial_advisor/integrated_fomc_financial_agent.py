import os
import json
from fomc_research.agent import root_agent as fomc_root_agent
from .agent import root_agent as financial_root_agent, is_valid_phone_number

def run_integrated_agent(phone_number, otp, fomc_input, financial_input):
    # Step 1: Validate phone number
    if not is_valid_phone_number(phone_number):
        return {"error": "Invalid phone number."}
    # Step 2: Validate OTP (static for demo)
    if otp != "123456":
        return {"error": "Invalid OTP."}
    # Step 3: Load user data
    test_data_dir = os.path.join(os.path.dirname(__file__), '..', '..', 'test_data_dir')
    user_dir = os.path.join(test_data_dir, phone_number)
    user_data = {}
    for fname in os.listdir(user_dir):
        if fname.endswith('.json'):
            fpath = os.path.join(user_dir, fname)
            with open(fpath, 'r', encoding='utf-8') as f:
                key = fname.replace('.json', '')
                try:
                    user_data[key] = json.load(f)
                except Exception:
                    user_data[key] = None
    # Step 4: Run MPC research agent and collect all outputs
    fomc_state = {}
    fomc_result = fomc_root_agent.run(fomc_input, state=fomc_state)
    # Collect all relevant fields from fomc_state after agent run
    financial_state = {
        'user_data': user_data,
        'mpc_research_output': fomc_result.get('output') if isinstance(fomc_result, dict) else fomc_result,
        'geopolitical_news': fomc_state.get('geopolitical_news', ''),
        'macroeconomic_news': fomc_state.get('macroeconomic_news', ''),
        'microeconomic_news': fomc_state.get('microeconomic_news', ''),
        'flight_log_details': fomc_state.get('flight_log_details', ''),
        'local_political_news': fomc_state.get('local_political_news', ''),
    }
    financial_result = financial_root_agent.run(financial_input, state=financial_state)
    return financial_result

# Example usage:
# result = run_integrated_agent('1010101010', '123456', 'Analyze the March 2024 MPC meeting.', 'What should I do with my portfolio?') 